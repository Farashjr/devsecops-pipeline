name: DevSecOps Security Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-test-sast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r app/requirements.txt
          pip install pytest bandit pip-audit jq

      - name: Run unit tests
        run: |
          export PYTHONPATH="$PYTHONPATH:$(pwd)"
          pytest app/tests

      - name: Run Bandit (SAST)
        run: |
          echo "Running Bandit scan..."
          bandit -r app -f json -o bandit-report.json || true
          echo "Bandit completed (continuing even if issues were found)."

      - name: Run pip-audit (dependency scan)
        run: |
          echo "Running pip-audit..."
          pip-audit -r app/requirements.txt -f json -o dep-report.json || true
          echo "pip-audit completed (continuing even if issues were found)."

      - name: Upload SAST & dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: sast-and-dep-reports
          path: |
            bandit-report.json
            dep-report.json

  trivy-scan:
    runs-on: ubuntu-latest
    needs: build-test-sast
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t devsecops-app:ci .

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: devsecops-app:ci
          format: 'table'
          exit-code: '1'
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'
          output: trivy-report.txt

      - name: Upload Trivy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.txt

  zap-dast:
    runs-on: ubuntu-latest
    needs: build-test-sast
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t devsecops-app:ci .

      - name: Run app container
        run: |
          docker run -d --name web -p 5000:5000 devsecops-app:ci
          echo "Waiting for app to become healthy..."
          for i in {1..10}; do
            if curl --fail http://localhost:5000/health; then
              echo "App is healthy!"
              break
            fi
            echo "Waiting..."
            sleep 3
          done

      - name: Run OWASP ZAP DAST scan
        run: |
          mkdir -p zap-reports
          chmod -R 777 zap-reports
          docker run \
            --network="host" \
            -v ${{ github.workspace }}/zap-config.yaml:/zap/wrk/zap-config.yaml \
            -v ${{ github.workspace }}/zap-reports:/zap/wrk/zap-reports \
            ghcr.io/zaproxy/zaproxy:stable zap.sh \
            -cmd -autorun /zap/wrk/zap-config.yaml

      - name: Stop containers
        if: always()
        run: docker stop web || true

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-reports/

  analyze-security:
    needs:
      - build-test-sast
      - trivy-scan
      - zap-dast
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Analyze security reports
        id: analyze
        run: |
          echo "Analyzing security reports..."

          BANDIT=$(jq '.results | length' reports/sast-and-dep-reports/bandit-report.json)
          AUDIT=$(jq '.dependencies | length' reports/sast-and-dep-reports/dep-report.json)

          TRIVY_HIGH=$(grep -c "HIGH" reports/trivy-report/trivy-report.txt || true)
          TRIVY_CRIT=$(grep -c "CRITICAL" reports/trivy-report/trivy-report.txt || true)

          ZAP_HIGH=$(grep -c "High (High)" reports/zap-report/zap-report.html || true)

          echo "bandit=$BANDIT" >> $GITHUB_OUTPUT
          echo "audit=$AUDIT" >> $GITHUB_OUTPUT
          echo "trivy_high=$TRIVY_HIGH" >> $GITHUB_OUTPUT
          echo "trivy_crit=$TRIVY_CRIT" >> $GITHUB_OUTPUT
          echo "zap_high=$ZAP_HIGH" >> $GITHUB_OUTPUT

          echo "=== SECURITY SUMMARY ===" > security-summary.txt
          echo "Bandit (SAST) findings: $BANDIT" >> security-summary.txt
          echo "pip-audit dependency issues: $AUDIT" >> security-summary.txt
          echo "Trivy HIGH vulnerabilities: $TRIVY_HIGH" >> security-summary.txt
          echo "Trivy CRITICAL vulnerabilities: $TRIVY_CRIT" >> security-summary.txt
          echo "ZAP HIGH alerts: $ZAP_HIGH" >> security-summary.txt

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.txt

  notify-security:
    needs: analyze-security
    if: >
      needs.analyze-security.outputs.trivy_high != '0' ||
      needs.analyze-security.outputs.trivy_crit != '0' ||
      needs.analyze-security.outputs.zap_high != '0' ||
      needs.analyze-security.outputs.bandit != '0' ||
      needs.analyze-security.outputs.audit != '0'
    runs-on: ubuntu-latest

    steps:
      - name: Download summary
        uses: actions/download-artifact@v4
        with:
          name: security-summary
          path: .

      - name: Send security alert email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: " HIGH Vulnerability Alert â€” DevSecOps Pipeline"
          to: ${{ secrets.MAIL_TO }}
          from: "DevSecOps Pipeline <${{ secrets.MAIL_USERNAME }}>"
          body: |
           DevSecOps Security Alert!

            High severity issues were detected in the latest CI run.

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

            === Summary ===
            $(cat security-summary.txt)

             Download full security reports:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Stay safe and secure.
